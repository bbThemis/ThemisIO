#!/bin/bash

ppn=56
iosize=1m
filesize=10m

offset=1
nodes=8

IBRUN_TASKS_PER_NODE=$ppn ibrun -n $(($ppn * $nodes)) -o $(($ppn * $offset)) \
   ../tests/themis_client.sh -u 101 -j $((1000*$nodes + 1)) -n $nodes \
   ./rw_speed -time=60 -iosize=$iosize -filesize=$filesize -tag=job1 &> rw_speed1.out &

offset=$(($offset + $nodes))
nodes=1

IBRUN_TASKS_PER_NODE=$ppn ibrun -n $(($ppn * $nodes)) -o $(($ppn * $offset)) \
   ../tests/themis_client.sh -u 102 -j $((1000*$nodes + 2)) -n $nodes -s 15 \
   ./rw_speed -time=30 -iosize=$iosize -filesize=$filesize -tag=job2 &> rw_speed2.out &

wait
cat rw_speed1.out
cat rw_speed2.out

# sed 's/# //' < test.8v1.sh | grep ^rw_speed.job | head -2 | ./format_throughput_slices.py > test.job-fair.8v1.txt
# sed 's/# //' < test.8v1.sh | grep ^rw_speed.job | tail -2 | ./format_throughput_slices.py > test.size-fair.8v1.txt

# server in job-fair mode

# rw_speed.job1 time=2021-09-02:15:10:56 nn=1 np=56 user=871101 jobid=3481282 mbps=15830.563 mbps_rank_stddev=41.431 mbps_1sec_time_slices=(8457.0,21349.0,21613.0,21998.0,22130.0,21973.0,22297.0,21887.0,21041.0,22547.0,21631.0,20913.0,22313.0,21804.0,21602.0,16820.0,7963.0,8236.0,8186.0,8423.0,8661.0,8725.0,8517.0,8871.0,9390.0,9555.0,9709.0,9211.0,9457.0,9530.0,10279.0,10346.0,10268.0,10347.0,10460.0,10090.0,10101.0,10014.0,10083.0,9873.0,9972.0,9968.0,9985.0,10320.0,17915.0,22284.0,22150.0,21994.0,21296.0,21742.0,21982.0,21520.0,22562.0,22361.0,20959.0,20859.0,21441.0,22045.0,21934.0,21748.0,53.0)
# rw_speed.job2 time=2021-09-02:15:10:40 nn=8 np=448 user=871101 jobid=3481282 mbps=9540.261 mbps_rank_stddev=0.304 mbps_1sec_time_slices=(0.0,3459.0,7956.0,8255.0,8512.0,8721.0,8513.0,8413.0,8650.0,8835.0,9752.0,9492.0,9791.0,9242.0,9389.0,9709.0,10484.0,10450.0,10325.0,10289.0,10570.0,10131.0,10189.0,10184.0,10176.0,10032.0,10047.0,10050.0,9991.0,10280.0,417.0)


# server in size-fair mode
# rw_speed.job1 time=2021-09-02:15:09:10 nn=1 np=56 user=871101 jobid=3481282 mbps=12376.998 mbps_rank_stddev=32.789 mbps_1sec_time_slices=(8177.0,20759.0,21306.0,22195.0,22514.0,20965.0,21813.0,21895.0,22186.0,22421.0,22605.0,22724.0,22000.0,22061.0,21739.0,19991.0,1616.0,1924.0,1899.0,1898.0,2036.0,2090.0,2061.0,2087.0,2338.0,2406.0,2425.0,2454.0,2468.0,2404.0,2333.0,2339.0,2348.0,2207.0,2392.0,2297.0,2382.0,2428.0,2390.0,2432.0,2475.0,2301.0,2330.0,2442.0,12845.0,20728.0,21213.0,22219.0,20724.0,20524.0,21538.0,22108.0,21318.0,22313.0,21896.0,21377.0,22136.0,21903.0,22413.0,22282.0,51.0)
# rw_speed.job2 time=2021-09-02:15:08:55 nn=8 np=448 user=871101 jobid=3481282 mbps=18022.152 mbps_rank_stddev=1.073 mbps_1sec_time_slices=(0.0,5027.0,14645.0,15341.0,15459.0,15847.0,16985.0,15695.0,16719.0,17751.0,18126.0,19404.0,18713.0,19417.0,19468.0,19431.0,19187.0,18681.0,18278.0,18371.0,18842.0,18529.0,19083.0,18809.0,19107.0,19098.0,19450.0,19077.0,19254.0,18809.0,416.0)

# re-run size-fair with long job as big job
# rw_speed time=2021-09-04:23:12:16 np=448 nn=8 sim_nn=8 rank0host=c202-002.frontera.tacc.utexas.edu -prefix=/myfs/rw_speed -iosize=1048576 -filesize=10485760 -time=60.0 -tag=job1
# rw_speed.job1 time=2021-09-04:23:13:15 nn=8 np=448 user=871101 jobid=3487190 mbps=18185.177 mbps_rank_stddev=0.610 mbps_1sec_time_slices=(0.0,5192.0,13304.0,15561.0,16094.0,15635.0,16977.0,18070.0,18441.0,19151.0,19090.0,19107.0,19935.0,18726.0,17980.0,18776.0,16523.0,16496.0,17090.0,18049.0,16912.0,16852.0,17838.0,17738.0,17839.0,17503.0,16182.0,15298.0,16256.0,16817.0,16363.0,17035.0,16240.0,16462.0,15890.0,16437.0,16069.0,16182.0,16683.0,17258.0,17174.0,17323.0,17712.0,17684.0,17916.0,18083.0,20780.0,21216.0,21348.0,21520.0,21547.0,21174.0,21596.0,21745.0,22007.0,22029.0,21633.0,21767.0,22130.0,22143.0,398.0)
# rw_speed time=2021-09-04:23:12:31 np=56 nn=1 sim_nn=1 rank0host=c202-010.frontera.tacc.utexas.edu -prefix=/myfs/rw_speed -iosize=1048576 -filesize=10485760 -time=30.0 -tag=job2
# rw_speed.job2 time=2021-09-04:23:13:01 nn=1 np=56 user=871101 jobid=3487190 mbps=2107.716 mbps_rank_stddev=5.702 mbps_1sec_time_slices=(1185.0,2210.0,2169.0,2184.0,2181.0,2085.0,2260.0,2223.0,2323.0,2158.0,1951.0,1962.0,2061.0,2083.0,1929.0,2238.0,2003.0,2006.0,1902.0,1937.0,2086.0,2007.0,2119.0,2122.0,2060.0,2239.0,2173.0,2214.0,2253.0,2286.0,49.0)

# longer run to achieve stable state
# rw_speed time=2021-09-06:16:48:59 np=448 nn=8 sim_nn=8 rank0host=c204-015.frontera.tacc.utexas.edu -prefix=/myfs/rw_speed -iosize=1048576 -filesize=10485760 -time=120.0 -tag=job1 -stagger=0
# rw_speed.job1 time=2021-09-06:16:50:57 nn=8 np=448 user=871101 jobid=3491135 mbps=20427.017 mbps_rank_stddev=0.224 mbps_1sec_time_slices=(0.0,5575.0,14301.0,15924.0,16626.0,17703.0,17249.0,17646.0,18127.0,19114.0,19596.0,21411.0,19856.0,19488.0,20269.0,21151.0,20834.0,19990.0,21290.0,21119.0,21095.0,20988.0,19830.0,20120.0,21704.0,22958.0,22932.0,23090.0,23263.0,23149.0,22979.0,21778.0,18919.0,18915.0,18499.0,18836.0,18453.0,18940.0,19249.0,19013.0,19736.0,20147.0,20429.0,20402.0,20439.0,20211.0,20224.0,20384.0,20403.0,20427.0,20396.0,20483.0,20450.0,20537.0,20462.0,20384.0,20338.0,20123.0,20193.0,20042.0,20165.0,20183.0,20065.0,20062.0,20354.0,20349.0,20492.0,20264.0,20202.0,20333.0,20465.0,20308.0,20290.0,20099.0,19965.0,19921.0,19914.0,20169.0,19939.0,20016.0,19887.0,20065.0,19968.0,19749.0,19737.0,19514.0,18939.0,18945.0,19002.0,18904.0,19212.0,21126.0,21313.0,21314.0,21830.0,21737.0,21853.0,21726.0,21827.0,22049.0,21862.0,22218.0,22063.0,21863.0,21935.0,21840.0,21877.0,21673.0,21946.0,21566.0,21469.0,21953.0,21909.0,22031.0,22278.0,22259.0,22161.0,22009.0,22096.0,22132.0,368.0)
# rw_speed time=2021-09-06:16:49:29 np=56 nn=1 sim_nn=1 rank0host=c204-023.frontera.tacc.utexas.edu -prefix=/myfs/rw_speed -iosize=1048576 -filesize=10485760 -time=60.0 -tag=job2 -stagger=0
# rw_speed.job2 time=2021-09-06:16:50:29 nn=1 np=56 user=871101 jobid=3491135 mbps=2490.450 mbps_rank_stddev=6.447 mbps_1sec_time_slices=(1015.0,2474.0,2363.0,2402.0,2246.0,2342.0,2247.0,2472.0,2368.0,2473.0,2508.0,2488.0,2580.0,2515.0,2554.0,2559.0,2474.0,2631.0,2616.0,2691.0,2607.0,2582.0,2502.0,2592.0,2629.0,2608.0,2560.0,2430.0,2506.0,2548.0,2568.0,2556.0,2552.0,2507.0,2579.0,2461.0,2562.0,2579.0,2598.0,2468.0,2615.0,2460.0,2635.0,2592.0,2526.0,2427.0,2393.0,2450.0,2507.0,2475.0,2494.0,2484.0,2464.0,2391.0,2479.0,2415.0,2361.0,2398.0,2370.0,2381.0,42.0)
