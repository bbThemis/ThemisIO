#!/bin/bash

#!/bin/bash

# ppn=56
# iosize=1m

# IBRUN_TASKS_PER_NODE=$ppn ibrun -n $(($ppn * 1)) -o $(($ppn * 2)) \
#    ../tests/themis_client.sh -u 101 -j 1001 -n 1 \
#    ./rw_speed -time=60 -iosize=$iosize -filesize=100m -tag=job1 &> rw_speed1.out &

# IBRUN_TASKS_PER_NODE=$ppn ibrun -n $(($ppn * 1)) -o $(($ppn * 3)) \
#    ../tests/themis_client.sh -u 102 -j 1002 -n 1 -s 15 \
#    ./rw_speed -time=30 -iosize=$iosize -filesize=100m -tag=job2 &> rw_speed2.out &

# wait
# cat rw_speed1.out
# cat rw_speed2.out


mpiexec.hydra -hostfile ../hostfile_client1 -np 56 -ppn 56 ../tests/themis_client.sh -u 101 -j 1001 -n 1 ./rw_speed -time=60 -iosize=1m -filesize=100m -tag=job1 &> rw_speed1.out &

mpiexec.hydra -hostfile ../hostfile_client2 -np 56 -ppn 56 ../tests/themis_client.sh -u 102 -j 1002 -n 1  -s 15  ./rw_speed -time=30 -iosize=1m -filesize=100m -tag=job2 &> rw_speed2.out &



wait
cat rw_speed1.out
cat rw_speed2.out

rw_speed.job1 time=2023-04-19:12:42:21 nn=1 np=56 user=101 jobid=1001 mbps=20010.682 mbps_rank_stddev=27.986 mbps_1sec_time_slices=(3955.0,17272.0,18289.0,18370.0,20292.0,19526.0,19217.0,19489.0,19522.0,21374.0,21361.0,21028.0,22189.0,22766.0,22158.0,15428.0,17248.0,18249.0,18117.0,18366.0,18257.0,18506.0,17372.0,18209.0,18893.0,18746.0,18347.0,18493.0,18746.0,19009.0,18986.0,18852.0,18678.0,19224.0,19167.0,19350.0,19543.0,19278.0,19010.0,19377.0,19734.0,19600.0,19348.0,19235.0,19707.0,21679.0,22280.0,22464.0,22646.0,22832.0,23009.0,23218.0,23174.0,23058.0,23077.0,23243.0,23158.0,23082.0,23175.0,23175.0,56.0)
rw_speed.job2 time=2023-04-19:12:42:06 nn=1 np=56 user=102 jobid=1002 mbps=18411.275 mbps_rank_stddev=17.550 mbps_1sec_time_slices=(7658.0,15731.0,17654.0,17948.0,18176.0,18312.0,18546.0,17986.0,18383.0,18436.0,18570.0,18073.0,18278.0,18533.0,18984.0,19143.0,18865.0,18601.0,18879.0,19498.0,18790.0,19387.0,19438.0,19487.0,19257.0,19219.0,19423.0,19032.0,19410.0,18807.0,56.0)








# rw_speed.job1 time=2023-03-29:06:50:25 nn=1 np=56 user=101 jobid=1001 mbps=15427.587 mbps_rank_stddev=36.037 mbps_1sec_time_slices=(2393.0,14332.0,17292.0,21656.0,21584.0,20570.0,19254.0,18178.0,19456.0,19217.0,20922.0,21361.0,21550.0,20670.0,20656.0,10044.0,9868.0,9191.0,9245.0,9840.0,9631.0,9996.0,9805.0,9896.0,10066.0,10065.0,10388.0,10162.0,10340.0,10545.0,10283.0,10459.0,9979.0,10189.0,10469.0,9828.0,10373.0,10810.0,10873.0,10427.0,10691.0,10206.0,10672.0,10998.0,12729.0,22286.0,22344.0,22556.0,22202.0,21427.0,21857.0,20924.0,21460.0,21081.0,21681.0,22249.0,21139.0,22286.0,21741.0,22640.0,55.0)
# rw_speed.job2 time=2023-03-29:06:50:10 nn=1 np=56 user=102 jobid=1002 mbps=10131.098 mbps_rank_stddev=36.399 mbps_1sec_time_slices=(4602.0,9629.0,9834.0,9115.0,9969.0,9928.0,9824.0,9596.0,10098.0,9816.0,9862.0,10509.0,10222.0,10005.0,10704.0,10353.0,10349.0,10206.0,9983.0,10478.0,10498.0,10104.0,10644.0,10605.0,10441.0,10569.0,10544.0,10361.0,11031.0,10507.0,55.0)

# rw_speed.job1 time=2023-03-29:06:04:36 nn=1 np=56 user=101 jobid=1001 mbps=20203.426 mbps_rank_stddev=25.173 mbps_1sec_time_slices=(2700.0,15617.0,18963.0,19887.0,21810.0,21693.0,20636.0,21035.0,21091.0,22177.0,22468.0,22490.0,22644.0,22785.0,22827.0,17959.0,15768.0,17573.0,17428.0,18121.0,18972.0,18979.0,19239.0,19079.0,19602.0,19198.0,19285.0,19413.0,19436.0,19460.0,19453.0,19319.0,19422.0,19226.0,19279.0,19300.0,19605.0,19263.0,18904.0,19165.0,18992.0,18712.0,19307.0,19225.0,19250.0,22331.0,22134.0,22182.0,22334.0,22360.0,22216.0,22009.0,21990.0,22041.0,21932.0,22307.0,22229.0,22767.0,22873.0,22963.0,54.0)
# rw_speed.job2 time=2023-03-29:06:04:21 nn=1 np=56 user=102 jobid=1002 mbps=18687.301 mbps_rank_stddev=15.921 mbps_1sec_time_slices=(4352.0,15575.0,17085.0,18075.0,18114.0,18575.0,19025.0,19075.0,19439.0,19328.0,19290.0,19374.0,19547.0,19314.0,19377.0,19109.0,19459.0,19294.0,19427.0,19581.0,19330.0,19406.0,19094.0,19155.0,19171.0,18993.0,18816.0,19133.0,19293.0,19240.0,56.0)

# server in job-fair mode

# rw_speed.job1 time=2021-09-02:12:42:12 nn=1 np=56 user=871101 jobid=3480910 mbps=15410.850 mbps_rank_stddev=47.901 mbps_1sec_time_slices=(7486.0,17167.0,15286.0,17413.0,17756.0,14309.0,17225.0,17917.0,18998.0,18509.0,18977.0,20335.0,19278.0,20043.0,19687.0,16660.0,9466.0,10809.0,9633.0,10061.0,10955.0,10176.0,10814.0,10586.0,10768.0,11123.0,11037.0,10580.0,11068.0,10681.0,11178.0,10871.0,10671.0,10921.0,10433.0,10366.0,11151.0,10492.0,10354.0,10128.0,10324.0,10198.0,10467.0,10540.0,10296.0,19768.0,22606.0,22824.0,22687.0,22802.0,22691.0,22799.0,22759.0,22676.0,22633.0,22635.0,22230.0,22363.0,22143.0,22117.0,54.0)
# rw_speed.job2 time=2021-09-02:12:41:57 nn=1 np=56 user=871101 jobid=3480910 mbps=10492.657 mbps_rank_stddev=27.079 mbps_1sec_time_slices=(4175.0,9672.0,10634.0,9412.0,10455.0,10701.0,10341.0,10865.0,10530.0,10784.0,11020.0,10835.0,10754.0,11306.0,10608.0,11234.0,11005.0,10478.0,10792.0,10200.0,10492.0,10811.0,10321.0,10583.0,10334.0,10170.0,10477.0,10249.0,10452.0,10330.0,56.0)


# server in size-fair mode
# rw_speed.job1 time=2021-09-02:15:00:12 nn=1 np=56 user=871101 jobid=3481282 mbps=14855.129 mbps_rank_stddev=49.017 mbps_1sec_time_slices=(6321.0,18231.0,15051.0,17560.0,15693.0,16884.0,17224.0,17731.0,18892.0,17547.0,19449.0,19396.0,18082.0,19358.0,19554.0,5977.0,7722.0,9965.0,10578.0,10723.0,10257.0,10271.0,10636.0,10275.0,10723.0,10966.0,9464.0,10645.0,10799.0,9999.0,10426.0,10227.0,10355.0,10531.0,10360.0,10532.0,10457.0,9946.0,10236.0,10661.0,10695.0,10087.0,10870.0,11001.0,13869.0,20849.0,20761.0,20406.0,21152.0,20727.0,21226.0,21660.0,20975.0,21829.0,21519.0,21890.0,21836.0,20763.0,21393.0,21307.0,55.0)
# rw_speed.job2 time=2021-09-02:14:59:56 nn=1 np=56 user=871101 jobid=3481282 mbps=10163.927 mbps_rank_stddev=23.744 mbps_1sec_time_slices=(2391.0,5693.0,10226.0,9859.0,11008.0,10941.0,9693.0,10705.0,10485.0,10658.0,11047.0,10294.0,10027.0,10994.0,10711.0,9750.0,10574.0,10047.0,10469.0,10700.0,10290.0,10817.0,9897.0,10073.0,10632.0,10446.0,10396.0,10414.0,10968.0,10692.0,56.0)

# 1v1 job-fair
# sed 's/# //' < test.1v1.sh | grep ^rw_speed.job | head -2 | ./format_throughput_slices.py > test.job-fair.1v1.txt

# 1v1 size-fair
# sed 's/# //' < test.1v1.sh | grep ^rw_speed.job | tail -2 | ./format_throughput_slices.py > test.size-fair.1v1.txt

# ppn=56
# iosize=5m

# IBRUN_TASKS_PER_NODE=$ppn ibrun -n $(($ppn * 1)) -o $(($ppn * 1)) \
#    ../tests/themis_client.sh -u 101 -j 1001 -n 1 \
#    ./rw_speed -time=15 -iosize=$iosize -filesize=10m -tag=job1 &> rw_speed1.out &

# IBRUN_TASKS_PER_NODE=$ppn ibrun -n $(($ppn * 1)) -o $(($ppn * 2)) \
#    ../tests/themis_client.sh -u 102 -j 1002 -n 1 -s 5 \
#    ./rw_speed -time=5 -iosize=$iosize -filesize=100m -tag=job2 &> rw_speed2.out &

# wait
# cat rw_speed1.out
# cat rw_speed2.out

# server in job-fair mode

# rw_speed.job1 time=2021-09-02:12:42:12 nn=1 np=56 user=871101 jobid=3480910 mbps=15410.850 mbps_rank_stddev=47.901 mbps_1sec_time_slices=(7486.0,17167.0,15286.0,17413.0,17756.0,14309.0,17225.0,17917.0,18998.0,18509.0,18977.0,20335.0,19278.0,20043.0,19687.0,16660.0,9466.0,10809.0,9633.0,10061.0,10955.0,10176.0,10814.0,10586.0,10768.0,11123.0,11037.0,10580.0,11068.0,10681.0,11178.0,10871.0,10671.0,10921.0,10433.0,10366.0,11151.0,10492.0,10354.0,10128.0,10324.0,10198.0,10467.0,10540.0,10296.0,19768.0,22606.0,22824.0,22687.0,22802.0,22691.0,22799.0,22759.0,22676.0,22633.0,22635.0,22230.0,22363.0,22143.0,22117.0,54.0)
# rw_speed.job2 time=2021-09-02:12:41:57 nn=1 np=56 user=871101 jobid=3480910 mbps=10492.657 mbps_rank_stddev=27.079 mbps_1sec_time_slices=(4175.0,9672.0,10634.0,9412.0,10455.0,10701.0,10341.0,10865.0,10530.0,10784.0,11020.0,10835.0,10754.0,11306.0,10608.0,11234.0,11005.0,10478.0,10792.0,10200.0,10492.0,10811.0,10321.0,10583.0,10334.0,10170.0,10477.0,10249.0,10452.0,10330.0,56.0)


# server in size-fair mode
# rw_speed.job1 time=2021-09-02:15:00:12 nn=1 np=56 user=871101 jobid=3481282 mbps=14855.129 mbps_rank_stddev=49.017 mbps_1sec_time_slices=(6321.0,18231.0,15051.0,17560.0,15693.0,16884.0,17224.0,17731.0,18892.0,17547.0,19449.0,19396.0,18082.0,19358.0,19554.0,5977.0,7722.0,9965.0,10578.0,10723.0,10257.0,10271.0,10636.0,10275.0,10723.0,10966.0,9464.0,10645.0,10799.0,9999.0,10426.0,10227.0,10355.0,10531.0,10360.0,10532.0,10457.0,9946.0,10236.0,10661.0,10695.0,10087.0,10870.0,11001.0,13869.0,20849.0,20761.0,20406.0,21152.0,20727.0,21226.0,21660.0,20975.0,21829.0,21519.0,21890.0,21836.0,20763.0,21393.0,21307.0,55.0)
# rw_speed.job2 time=2021-09-02:14:59:56 nn=1 np=56 user=871101 jobid=3481282 mbps=10163.927 mbps_rank_stddev=23.744 mbps_1sec_time_slices=(2391.0,5693.0,10226.0,9859.0,11008.0,10941.0,9693.0,10705.0,10485.0,10658.0,11047.0,10294.0,10027.0,10994.0,10711.0,9750.0,10574.0,10047.0,10469.0,10700.0,10290.0,10817.0,9897.0,10073.0,10632.0,10446.0,10396.0,10414.0,10968.0,10692.0,56.0)

# 1v1 job-fair
# sed 's/# //' < test.1v1.sh | grep ^rw_speed.job | head -2 | ./format_throughput_slices.py > test.job-fair.1v1.txt

# 1v1 size-fair
# sed 's/# //' < test.1v1.sh | grep ^rw_speed.job | tail -2 | ./format_throughput_slices.py > test.size-fair.1v1.txt
