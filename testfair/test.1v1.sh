#!/bin/bash

ppn=56
iosize=1m

IBRUN_TASKS_PER_NODE=$ppn ibrun -n $(($ppn * 1)) -o $(($ppn * 1)) \
   bash ../tests/themis_client.sh -u 101 -j 1001 -n 1 \
   ./rw_speed -time=60 -iosize=$iosize -filesize=100m -tag=job1 &> rw_speed1.out &

IBRUN_TASKS_PER_NODE=$ppn ibrun -n $(($ppn * 1)) -o $(($ppn * 2)) \
   bash ../tests/themis_client.sh -u 102 -j 1002 -n 1 -s 15 \
   ./rw_speed -time=30 -iosize=$iosize -filesize=100m -tag=job2 &> rw_speed2.out &

wait
cat rw_speed1.out
cat rw_speed2.out

# server in gift mode
# rw_speed.job1 time=2022-03-30:17:41:11 nn=1 np=56 user=878709 jobid=4200416 mbps=14404.371 mbps_rank_stddev=42.353 mbps_1sec_time_slices=(0.0,3315.0,10259.0,16264.0,13790.0,17483.0,17186.0,15995.0,15876.0,17500.0,18263.0,18749.0,18248.0,19537.0,20305.0,18938.0,4347.0,8380.0,10161.0,8715.0,9346.0,11120.0,10249.0,10556.0,10664.0,10023.0,9698.0,9638.0,10160.0,9851.0,9979.0,9469.0,10873.0,11793.0,11656.0,11000.0,10593.0,9767.0,11789.0,10942.0,9544.0,10139.0,10212.0,9059.0,13874.0,20536.0,20320.0,20261.0,20299.0,20253.0,20731.0,20643.0,20381.0,21046.0,20867.0,20725.0,20942.0,20363.0,20578.0,21042.0,56.0)
# rw_speed.job2 time=2022-03-30:17:40:56 nn=1 np=56 user=878709 jobid=4200416 mbps=9804.601 mbps_rank_stddev=25.056 mbps_1sec_time_slices=(0.0,2225.0,5132.0,9512.0,8897.0,8974.0,9042.0,9016.0,8606.0,8419.0,11275.0,9887.0,8765.0,11101.0,10752.0,11169.0,10967.0,9949.0,9800.0,10228.0,10261.0,10624.0,10291.0,11341.0,9343.0,11432.0,10123.0,10995.0,10338.0,12086.0,55.0)

# server in job-fair mode

# rw_speed.job1 time=2021-09-02:12:42:12 nn=1 np=56 user=871101 jobid=3480910 mbps=15410.850 mbps_rank_stddev=47.901 mbps_1sec_time_slices=(7486.0,17167.0,15286.0,17413.0,17756.0,14309.0,17225.0,17917.0,18998.0,18509.0,18977.0,20335.0,19278.0,20043.0,19687.0,16660.0,9466.0,10809.0,9633.0,10061.0,10955.0,10176.0,10814.0,10586.0,10768.0,11123.0,11037.0,10580.0,11068.0,10681.0,11178.0,10871.0,10671.0,10921.0,10433.0,10366.0,11151.0,10492.0,10354.0,10128.0,10324.0,10198.0,10467.0,10540.0,10296.0,19768.0,22606.0,22824.0,22687.0,22802.0,22691.0,22799.0,22759.0,22676.0,22633.0,22635.0,22230.0,22363.0,22143.0,22117.0,54.0)
# rw_speed.job2 time=2022-03-07:10:23:07 nn=1 np=56 user=878709 jobid=4128662 mbps=9177.901 mbps_rank_stddev=28.345 mbps_1sec_time_slices=(4149.0,7569.0,9437.0,8376.0,7384.0,9346.0,9742.0,9119.0,9222.0,10498.0,8433.0,9054.0,9522.0,9796.0,8039.0,10305.0,8660.0,8623.0,9933.0,9948.0,9593.0,8979.0,8544.0,9741.0,9719.0,9952.0,9588.0,8931.0,9964.0,10206.0,55.0)


# server in size-fair mode
# rw_speed.job1 time=2021-09-02:15:00:12 nn=1 np=56 user=871101 jobid=3481282 mbps=14855.129 mbps_rank_stddev=49.017 mbps_1sec_time_slices=(6321.0,18231.0,15051.0,17560.0,15693.0,16884.0,17224.0,17731.0,18892.0,17547.0,19449.0,19396.0,18082.0,19358.0,19554.0,5977.0,7722.0,9965.0,10578.0,10723.0,10257.0,10271.0,10636.0,10275.0,10723.0,10966.0,9464.0,10645.0,10799.0,9999.0,10426.0,10227.0,10355.0,10531.0,10360.0,10532.0,10457.0,9946.0,10236.0,10661.0,10695.0,10087.0,10870.0,11001.0,13869.0,20849.0,20761.0,20406.0,21152.0,20727.0,21226.0,21660.0,20975.0,21829.0,21519.0,21890.0,21836.0,20763.0,21393.0,21307.0,55.0)
# rw_speed.job2 time=2021-09-02:14:59:56 nn=1 np=56 user=871101 jobid=3481282 mbps=10163.927 mbps_rank_stddev=23.744 mbps_1sec_time_slices=(2391.0,5693.0,10226.0,9859.0,11008.0,10941.0,9693.0,10705.0,10485.0,10658.0,11047.0,10294.0,10027.0,10994.0,10711.0,9750.0,10574.0,10047.0,10469.0,10700.0,10290.0,10817.0,9897.0,10073.0,10632.0,10446.0,10396.0,10414.0,10968.0,10692.0,56.0)

# 1v1 gift
# sed 's/# //' < test.1v1.sh | grep ^rw_speed.job | head -2 | python3 ./format_throughput_slices.py > test.gift.1v1.txt

# 1v1 job-fair
# sed 's/# //' < test.1v1.sh | grep ^rw_speed.job | head -2 | ./format_throughput_slices.py > test.job-fair.1v1.txt

# 1v1 size-fair
# sed 's/# //' < test.1v1.sh | grep ^rw_speed.job | tail -2 | ./format_throughput_slices.py > test.size-fair.1v1.txt